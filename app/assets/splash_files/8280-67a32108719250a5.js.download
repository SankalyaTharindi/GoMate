"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8280],{50267:(e,t,n)=>{n.d(t,{y:()=>u});var a=n(19736),r=n(64328),i=n(41473);function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;if(e.length<=t)return e;let n=Math.ceil(t/2);return"".concat(e.substring(0,n),"\n\n  [...]\n\n  ").concat(e.substring(e.length-n))}var l=n(7620);function u(e,t,n){let[u,o]=(0,l.useState)(!1),{activeOrganization:d}=(0,r.YL)(),c=null==e?void 0:e.name,m=(null==t?void 0:t.length)||0,f=(0,l.useMemo)(()=>{let e=null==t?void 0:t[0];return e?(0,i.C)(e):""},[t]),g=(0,l.useMemo)(()=>{if(f)return f;let e=(null==t?void 0:t[1])?(0,i.C)(t[1]):"";return e&&!n?["Message 1:",s(f),"Message 2:",s(e)].join("\n\n"):""},[t,n,f]),p=(null==e?void 0:e.uuid)||"",{mutate:v}=(0,a.HI)(p),{mutate:_,error:h}=(0,a.OZ)(p),y=(0,l.useRef)(!1);(0,l.useEffect)(()=>{if(h&&!c&&f){if(y.current)return;let e=f.slice(0,30),t=f.length>30?"...":"";y.current=!0,v({name:"".concat(e).concat(t)})}},[h,c,g,v,f]),(0,l.useEffect)(()=>{d&&!u&&!c&&0!==m&&g&&(o(!0),_({message_content:g,recent_titles:[]}))},[d,c,_,u,m,g])}},68280:(e,t,n)=>{n.d(t,{J:()=>er});var a=n(54568),r=n(19736),i=n(47592),s=n(18849),l=n(58841),u=n(50267),o=n(65279),d=n(64328),c=n(80688),m=n(4869),f=n(7620),g=n(37380),p=n(91820);let v=(e,t)=>{let n=(0,m.useQueryClient)(),{activeOrganization:a}=(0,d.YL)(),i=null==a?void 0:a.uuid,s=(0,r.oF)(),l=(0,f.useRef)(void 0),u=(0,p.$)(),o=(0,f.useCallback)(async(e,t)=>{let a=[c.fC,{orgUuid:i},{uuid:e}],r=n.getQueryData(a);if(!r)throw Error("Conversation tree must be provided for append");l.current=t(r),await n.cancelQueries({queryKey:a}),n.setQueryData(a,l.current)},[n,i]),v=(0,f.useRef)(new Set),_=(0,f.useCallback)((a,r)=>{if(0!==r.length){if(e&&!v.current.has(a)&&r.some(e=>"text"===e.type&&e.text&&e.text.trim().length>0)&&(v.current.add(a),e()),t){var s,u;t(null!=(u=null==(s=l.current)?void 0:s.uuid)?u:"",a,r);return}n.setQueryData([c.fC,{orgUuid:i},{uuid:a}],()=>{let e=l.current;if(!e)throw Error("Conversation tree must be provided for incremental completion");if(!e.current_leaf_message_uuid)throw Error("Couldn't figure out where to put completion");let t=e.messageByUuid.get(e.current_leaf_message_uuid);if(!t)throw Error("New assistant message not found");return t.content=r,{...e,created_at:new Date().toISOString()}})}},[n,i,e,t]);return{onStartAppend:o,onStreamCompleted:(0,f.useCallback)((e,t,a,o)=>{(null==o?void 0:o.shouldRefetch)!==!1&&(s(e,i,a),n.invalidateQueries({queryKey:["FEATURE_LIMITS",i]}));let d=l.current,m=(null==d?void 0:d.chat_messages)&&d.chat_messages.length<=2;d&&m&&!d.is_temporary&&(n.setQueriesData({queryKey:[c.DC,{orgUuid:i}],predicate:e=>{let{queryKey:t}=e,n=t[2];return!(null==n?void 0:n.starred)}},t=>!t||t.some(t=>t.uuid===e)?t:[{uuid:e,name:d.name,summary:d.summary,updated_at:d.updated_at,created_at:d.created_at,project_uuid:d.project_uuid,model:d.model,settings:d.settings,is_starred:!1},...t].slice(0,r.sk)),n.setQueryData([c.Ad,{orgUuid:i}],e=>{var t;return{is_first_conversation:!1,count:(null!=(t=null==e?void 0:e.count)?t:0)+1}})),t&&i&&u(t,i,e)},[n,u,i,s]),onIncrementalCompletion:_,changeDisplayedConversationPath:(0,f.useCallback)((e,t,a,r)=>{n.setQueryData([c.fC,{orgUuid:i},{uuid:e}],e=>{if(!e)throw Error("Conversation tree must be provided for changeDisplayedConversationPath");let n=(0,g.gX)(e,t,a);return n.current_leaf_message_uuid&&r&&r(n.current_leaf_message_uuid),n})},[n,i])}};var _=n(74813),h=n(98944),y=n(41473),x=n(68067),b=n(27541),S=n(55188),C=n(23812),k=n(3075),j=n(10369),w=n(59666),M=n(1230),E=n(45271),N=n(13750),R=n(17300),I=n(859),A=n(91667),T=n(26334),D=n(72902);function L(e){let{fieldName:t,fieldSchema:n,isRequired:r,initialValue:i,hasSubmitError:s,clearSubmitError:l}=e,u=(0,j.A)(),[o,d]=(0,f.useState)(i),[c,m]=(0,f.useState)(s?z(o,n,r,u):null),g=(0,f.useCallback)(()=>{m(null),null==l||l(t)},[l,t]),p=(0,f.useCallback)(()=>{m(z(o,n,r,u))},[o,n,r,u]),v=n.type,_=n.title||n.description||t.charAt(0).toUpperCase()+t.slice(1),h=n.title&&n.description,y=(0,a.jsxs)("div",{className:"flex items-center",children:[(0,a.jsx)("span",{children:_}),r&&(0,a.jsx)("span",{className:"text-danger-000",children:"*"})]}),x=e=>(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)(I.J,{label:y,className:"font-medium"}),h&&(0,a.jsx)("p",{className:"text-xs text-text-300 mb-1",children:n.description}),e,c&&(0,a.jsx)("p",{className:"text-xs text-danger-000 mt-1",children:c})]});switch(v){case"boolean":return(0,a.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,a.jsx)("input",{type:"hidden",name:t,value:o?"true":""}),(0,a.jsx)(R.S,{label:y,checked:!!o,onChange:e=>d(e),onFocus:g,onBlur:p,size:16,className:c?"border-danger-000":""}),h&&(0,a.jsx)("p",{className:"text-xs text-text-300 ml-[28px]",children:n.description}),c&&(0,a.jsx)("p",{className:"text-xs text-danger-000 ml-[28px]",children:c})]});case"number":return x((0,a.jsx)(N.ks,{name:t,type:"number",value:String(null!=o?o:""),onValueChange:e=>{if(!e)return void d("");let t=Number(e);isNaN(t)||d(t)},onFocus:g,onBlur:p,error:!!c,size:"lg",min:n.minimum,max:n.maximum,step:"any"}));case"integer":return x((0,a.jsx)(N.ks,{name:t,type:"number",value:String(null!=o?o:""),onValueChange:e=>{if(!e)return void d("");let t=Number(e);!isNaN(t)&&Number.isInteger(t)&&d(t)},onKeyDown:e=>{("."===e.key||"e"===e.key||"E"===e.key)&&e.preventDefault()},onFocus:g,onBlur:p,error:!!c,size:"lg",min:n.minimum,max:n.maximum,step:1}));case"string":{if(n.enum){let e=n.enum,r=n.enumNames;return x((0,a.jsxs)(A.l,{name:t,value:String(null!=o?o:""),onChange:e=>d(e.target.value),onFocus:g,onBlur:p,variant:c?"danger":"outline",size:"lg",children:[(0,a.jsx)("option",{value:""}),e.map((e,t)=>(0,a.jsx)("option",{value:String(e),children:(null==r?void 0:r[t])||String(e)},t))]}))}let e=n.minLength,r=n.maxLength,s=n.format;if(!s)return x((0,a.jsx)(N.fs,{name:t,value:String(null!=o?o:""),onChange:e=>d(e.target.value),onFocus:g,onBlur:p,minRows:String(null!=i?i:"").split("\n").length,className:c?"border-danger-000":"",minLength:e,maxLength:r}));return x((0,a.jsx)("input",{name:t,type:s,value:String(null!=o?o:""),onChange:e=>d(e.target.value),onFocus:g,onBlur:p,className:(0,D.A)((0,T.j)({size:"lg",error:!!c})),minLength:e,maxLength:r}))}default:return null}}function z(e,t,n,a){if(n){if("boolean"===t.type){if(!0!==e)return a.formatMessage({defaultMessage:"This field must be checked.",id:"J5kfUK4Fet"})}else if(null==e||""===e||"string"==typeof e&&!e.trim())return a.formatMessage({defaultMessage:"This field is required.",id:"6B5JtuWEoY"})}if(null==e||""===e)return null;if("string"===t.type){let n=String(e);if("minLength"in t){let e=t.minLength;if(n.length<e)return a.formatMessage({defaultMessage:"Must be at least {min} characters.",id:"6JNvt/A47+"},{min:e})}if("maxLength"in t){let e=t.maxLength;if(n.length>e)return a.formatMessage({defaultMessage:"Must be at most {max} characters.",id:"oVARYXBJid"},{max:e})}if("pattern"in t&&!new RegExp(t.pattern).test(n))return a.formatMessage({defaultMessage:"Invalid format.",id:"vChcf7nVHS"});if("format"in t){let e=t.format;if("email"===e&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n))return a.formatMessage({defaultMessage:"Invalid email address.",id:"cpZU48Uo5t"});if("uri"===e)try{new URL(n)}catch(e){return a.formatMessage({defaultMessage:"Invalid URL.",id:"ZtqJIdqRiK"})}if("date"===e&&isNaN(new Date(n).getTime()))return a.formatMessage({defaultMessage:"Invalid date.",id:"bnRxzOhnEE"});if("date-time"===e&&isNaN(new Date(n).getTime()))return a.formatMessage({defaultMessage:"Invalid date and time.",id:"HTTZjKGN9a"})}}if("number"===t.type||"integer"===t.type){let n=Number(e);if(isNaN(n))return a.formatMessage({defaultMessage:"Must be a valid number.",id:"Z8e10tpxeL"});if("integer"===t.type&&!Number.isInteger(n))return a.formatMessage({defaultMessage:"Must be a whole number.",id:"5kFFmX4YGx"});if("minimum"in t){let e=t.minimum;if(n<e)return a.formatMessage({defaultMessage:"Must be at least {min}.",id:"85q0hz8G+z"},{min:e})}if("maximum"in t){let e=t.maximum;if(n>e)return a.formatMessage({defaultMessage:"Must be at most {max}.",id:"HrCLJ+XSxg"},{max:e})}}return null}function O(){let e=(0,j.A)(),t=(0,M.c)(e=>e.currentRequest),{acceptElicitation:n,declineElicitation:r,cancelElicitation:i}=(0,M.c)(),[s,l]=(0,f.useState)(new Set),u=(0,f.useMemo)(()=>{if(!t)return{};let e={};return Object.entries(t.request.params.requestedSchema.properties).forEach(t=>{let[n,a]=t;"default"in a&&void 0!==a.default&&(e[n]=a.default)}),e},[t]),o=(0,f.useCallback)(a=>{if(a.preventDefault(),!t)return;let r=a.currentTarget,i=new FormData(r),s={},u=new Set,o=t.request.params.requestedSchema;if(Object.entries(o.properties).forEach(t=>{var n,a;let[r,l]=t,d=i.get(r),c=d;"number"===l.type||"integer"===l.type?c=""===d||null===d?void 0:Number(d):"boolean"===l.type&&(c="true"===d),s[r]=c,z(c,l,null!=(a=null==(n=o.required)?void 0:n.includes(r))&&a,e)&&u.add(r)}),u.size>0){l(u);let e=Array.from(u)[0],t=r.querySelector('[name="'.concat(e,'"]'));null==t||t.scrollIntoView({behavior:"smooth",block:"center"});return}n(s),l(new Set)},[t,n,e]),d=(0,f.useCallback)(()=>{r(),l(new Set)},[r]),c=(0,f.useCallback)(()=>{i(),l(new Set)},[i]),m=(0,f.useCallback)(e=>()=>{l(t=>{let n=new Set(t);return n.delete(e),n})},[]);if(!t)return null;let{request:g,serverName:p,iconType:v,iconSrc:_}=t,h=g.params.requestedSchema,y=(0,a.jsx)(E.z,{size:30,imageSize:20,name:p,type:v,src:_});return(0,a.jsx)(k.aF,{title:"".concat(p," requests your input"),icon:y,isOpen:null!==t,onClose:c,modalSize:"lg",children:(0,a.jsxs)("form",{onSubmit:o,children:[(0,a.jsx)("div",{className:"py-4",children:(0,a.jsxs)("div",{className:"flex flex-col gap-4 max-h-[500px] overflow-y-auto p-2",children:[g.params.message&&(0,a.jsx)("p",{className:"text-sm text-text-300",children:g.params.message}),Object.entries(h.properties).map(e=>{var t,n;let[r,i]=e;return(0,a.jsx)(L,{fieldName:r,fieldSchema:i,isRequired:null!=(n=null==(t=h.required)?void 0:t.includes(r))&&n,initialValue:u[r],hasSubmitError:s.has(r),clearSubmitError:m},r)})]})}),(0,a.jsxs)(k.vW,{children:[(0,a.jsx)(C.$,{type:"button",onClick:d,variant:"secondary",children:(0,a.jsx)(w.A,{defaultMessage:"Decline",id:"pvtgR26QWY"})}),(0,a.jsx)(C.$,{type:"submit",variant:"primary",children:(0,a.jsx)(w.A,{defaultMessage:"Submit",id:"wSZR47Y5kj"})})]})]})})}var U=n(47606),F=n(98667),q=n(24423),P=n(76479),Q=n(8019),B=n(88590),V=n(74086),Y=n(73356),K=n(43402);function W(e){return"integration_name"in e&&e.integration_name?(0,K.v)(V.WK,{toolVariant:{case:"frontendRemoteMcpTool",value:(0,K.v)(V.Ky,{name:e.name,description:e.description,inputSchema:e.input_schema,namespacedName:"",mcpServerUuid:"mcp_server_uuid"in e?e.mcp_server_uuid:void 0,integrationName:e.integration_name,integrationIconUrl:"integration_icon_url"in e?e.integration_icon_url:void 0})}}):"type"in e&&!("input_schema"in e)?(0,K.v)(V.WK,{toolVariant:{case:"anthropicTool",value:(0,K.v)(V.a3,{type:e.type,name:e.name})}}):"input_schema"in e&&"description"in e?(0,K.v)(V.WK,{toolVariant:{case:"claudeAiTool",value:(0,K.v)(V.aA,{name:e.name,description:e.description,inputSchema:e.input_schema})}}):(0,K.v)(V.WK,{toolVariant:{case:"anthropicTool",value:(0,K.v)(V.a3,{type:"name"in e&&e.name?e.name:"unknown",name:e.name})}})}let H=e=>{};function J(e){var t;let n=(0,x.fS)("claudeai_use_cached_stream"),a=(0,f.useCallback)(t=>(q.oz.getState().pathUuidsByConversation[e.conversationUuid]||[]).includes(t),[e.conversationUuid]),r=(0,f.useCallback)(t=>{let n=q.oz.getState().pathUuidsByConversation[e.conversationUuid]||[],a=n.indexOf(t);return a>=0&&a<n.length-1?n[a+1]:null},[e.conversationUuid]),i=(0,f.useRef)(H),{hasActiveStream:s}=((e,t,n)=>{let a=(()=>{let{activeOrganization:e}=(0,d.YL)();if(!e)throw Error("No active organization");return(0,f.useMemo)(()=>(0,P.wV)(e.uuid),[e.uuid])})(),[r,i]=(0,f.useState)(!1),[s,l]=(0,f.useState)(!1),[u,o]=(0,f.useState)(null),c=(0,f.useRef)(null),m=(0,f.useRef)(n);return(0,f.useEffect)(()=>{m.current=n},[n]),(0,f.useEffect)(()=>{if(t)return c.current=new AbortController,(async()=>{try{var t;o(null);let n=a.streamPendingCompletion((0,K.v)(V.mM,{chatConversationUuid:e}),{signal:null==(t=c.current)?void 0:t.signal});for await(let e of(i(!0),l(!0),n))if("completionEventJson"===e.payload.case)try{let t=JSON.parse(e.payload.value);m.current(t)}catch(e){Y.v.error(Y.u.CHAT_COMPLETION,"Failed to parse completion event",e)}}catch(e){"not_found"===e.code?l(!1):"AbortError"!==e.name&&(o(e),Y.v.error(Y.u.CHAT_COMPLETION,"Stream pending completion error",e))}finally{i(!1)}})(),()=>{var e;null==(e=c.current)||e.abort()}},[e,a,t]),{isConnected:r,hasActiveStream:s,error:u}})(e.conversationUuid,n,i.current),l=(0,B.S)({...e,enableCaching:n,...n&&{hasActiveStream:s,checkMessageExists:a,getAssistantMessageUuid:r}});i.current=l.handleEvent;let u=(0,f.useCallback)(async t=>{if(n){let n=e.getTools().map(W);return l.runStream({...t,enableCaching:!0,grpcTools:n})}return l.runStream(t)},[n,e,l]);return{...l,runStream:u,isCachedStreaming:n,isReconnected:null!=(t=l.isReconnected)&&t}}var Z=n(77181),G=n(69351),X=n(1613),$=n(35984),ee=n(16178);function et(e){var t,n,i,s;let{conversation:l,conversationUuid:c,chatInputDefaultMessage:p}=e,C=(0,b.useRouter)(),{incognitoModeEnabled:k}=(0,S.S)(),{track:j}=(0,_.st)(),{data:w,isLoading:M,isRefetching:E,isPlaceholderData:N}=(0,r.Bq)(c,{suppressError:!0}),R=(0,f.useMemo)(()=>{if((null==w?void 0:w.danglingHumanMessages)&&w.danglingHumanMessages.length>0)return w.danglingHumanMessages[w.danglingHumanMessages.length-1]},[w]),I=null==w?void 0:w.project_uuid,A=(0,q.gq)(),T=(0,q.xw)(c),{changeDisplayedConversationPath:D}=v(),L=(0,o.Z3)(c),z=(0,G.n)(null!=(n=null==l?void 0:l.settings)?n:null==w?void 0:w.settings,null==l?void 0:l.project_uuid),{markFirstTokenReceived:B}=(0,F.B)(),V=(0,f.useCallback)(()=>{B({model:L,integrations:function(e){if(!e)return"";let t=[];return Object.entries(e).forEach(e=>{var n,a;let[r,i]=e,s="enabled_mcp_tools"===r&&!("object"!=typeof i||null===i||Array.isArray(i))&&Object.values(i).every(e=>"boolean"==typeof e),l="paprika_mode"===r&&"string"==typeof(n=i)&&"extended"===n,u="compass_mode"===r&&"string"==typeof(a=i)&&"advanced"===a;s?Object.entries(i).forEach(e=>{let[n,a]=e;a&&t.push(n)}):l?t.push("enabled_paprika"):u?t.push("enabled_compass"):"boolean"==typeof i&&i&&t.push(r)}),t.join(",")}(null==w?void 0:w.settings)})},[B,L,null==w?void 0:w.settings]);(0,f.useEffect)(()=>{if(!k||!(null==w?void 0:w.updated_at))return;let e=()=>{let e=new Date(w.updated_at).getTime();(Date.now()-e)/36e5>=47&&C.push("/new")};return window.addEventListener("focus",e),()=>{window.removeEventListener("focus",e)}},[k,null==w?void 0:w.updated_at,C]);let[Y,K]=(0,f.useState)(),W=(0,f.useCallback)(e=>{K(e)},[K]),[H,et]=(0,f.useState)(0),en=(0,f.useCallback)(e=>{et(e)},[]),ea=(0,x.fS)("claudeai_use_cached_stream"),er=function(e,t,n,a,r,i,s){let{onIncrementalCompletion:l,onStartAppend:u,onStreamCompleted:o}=v(a,r),d=J({conversationUuid:e,projectUuid:t,endpoint:P.ep.APPEND_MESSAGE_WITH_COMPLETION,onIncrementalCompletion:l,onStreamCompleted:o,getTools:n,onRetry:i,pendingUserMessage:s,onStartAppend:u}),{runStream:c}=d,m=(0,f.useCallback)(async t=>{let{prompt:n,attachments:a,files:r,syncSources:i,rethrowErrors:s=!1,modelOverride:l,parent_message_uuid:o,personalized_style:d,compass_mode:m,org_type_override:f}=t,p="".concat(g.EL,"-").concat((0,Q.b)()),v="".concat(g.B6,"-").concat((0,Q.b)());await u(e,e=>{if(!e)throw Error("Conversation tree must be provided for tree append");let t=(0,g.ZQ)(e),s=[{uuid:p,content:[{type:"text",text:n,citations:[]}],created_at:new Date().toISOString(),sender:"human",attachments:a,files:r,files_v2:r,sync_sources:i,index:t+1,parent_message_uuid:null!=o?o:g.gF},{uuid:v,content:[],created_at:new Date().toISOString(),sender:"assistant",attachments:[],files:[],files_v2:[],sync_sources:[],index:t+2,parent_message_uuid:p,metadata:{compass_mode:m}}];return(0,g.xQ)(e,s)}),await c({prompt:n,attachments:a,files:r,syncSources:i,rethrowErrors:s,modelOverride:l,parent_message_uuid:o,personalized_style:d,compass_mode:null!=m?m:void 0,org_type_override:f})},[c,u,e]);return{...d,runStream:m}}(c,I,z,V,A,en,ea?R:void 0),ei=function(e,t,n,a,r,i,s,l){let{onIncrementalCompletion:u,onStreamCompleted:o,onStartAppend:d}=v(r,i),c=J({conversationUuid:e,projectUuid:t,endpoint:P.ep.RETRY_MESSAGE_WITH_COMPLETION,onIncrementalCompletion:u,onStreamCompleted:o,getTools:n,onRetry:s,pendingUserMessage:l,onStartAppend:d}),{runStream:m}=c,p=(0,f.useCallback)(async(t,n,r,i)=>{let s="".concat(g.B6,"-").concat((0,Q.b)());await d(e,e=>{let n=[{uuid:s,content:[],created_at:new Date().toISOString(),sender:"assistant",attachments:[],files:[],files_v2:[],sync_sources:[],parent_message_uuid:t,selectedOption:0,index:(0,g.ZQ)(e)+1}];return(0,g.xQ)(e,n)}),await m({prompt:"",attachments:[],files:[],syncSources:[],parent_message_uuid:t,personalized_style:a,paprika_mode:null!=n?n:void 0,compass_mode:null!=r?r:void 0,isRetry:!0,modelOverride:i})},[e,m,d,a]);return{...c,runStream:p}}(c,I,z,Y,V,A,en,ea?R:void 0),{mutate:es}=(0,r.lj)(c),el=er.isStreaming||ei.isStreaming,eu=er.isReconnected||ei.isReconnected,eo=(0,f.useCallback)(async e=>(et(0),er.runStream(e)),[er]),ed=(0,f.useCallback)(async(e,t,n,a)=>(et(0),ei.runStream(e,t,n,a)),[ei]);(0,u.y)(w,null==w?void 0:w.chat_messages,el);let ec=null==(t=(0,q.Q3)(c))?void 0:t.uuid,em=(0,f.useCallback)(async(e,t)=>{var n,a;let r=(0,y.C)(e);r!==t&&(j({event_key:"claudeai.message.edited",is_last_human_message:e.uuid===ec,is_identical_content:r===t}),await eo({prompt:t,attachments:e.attachments,files:null!=(a=e.files_v2)?a:e.files,syncSources:e.sync_sources,parent_message_uuid:e.parent_message_uuid,personalized_style:Y,compass_mode:null==(n=e.metadata)?void 0:n.compass_mode}))},[eo,Y,j,ec]),ef=(0,f.useCallback)((e,t)=>{j({event_key:"claudeai.conversation_tree.navigated",direction:1===t?"next":"previous",is_last_human_message:e.uuid===ec}),D(c,e,t,e=>es({current_leaf_message_uuid:e}))},[D,c,es,j,ec]),{hasPendingUserMessage:eg,isCompletionStatusLoading:ep,stopPendingRecovery:ev}=function(e){let{conversationUuid:t,pendingUserMessage:n,chatConversationTree:a,isLoading:i}=e,s=(0,f.useRef)(!1),l=(0,f.useRef)(null),u=(0,f.useRef)(null),c=(0,f.useRef)(null),g=(0,q.uQ)(),p=(0,q.Gu)(),v=(0,q.RR)(),{activeOrganization:_}=(0,d.YL)(),{addError:h}=(0,$.Y)(),{setFailedStreamRetryData:y}=(0,o.x)(),x=(0,m.useQueryClient)(),[b,S]=(0,f.useState)(!1),[C,k]=(0,f.useState)(!1),{data:j,isLoading:w}=(0,X.Sk)((null==_?void 0:_.uuid)&&t&&n?"/api/organizations/".concat(_.uuid,"/chat_conversations/").concat(t,"/completion_status?poll=false"):"",{enabled:!!(null==_?void 0:_.uuid)&&!!t&&!i&&!!n&&!s.current,staleTime:0,refetchOnWindowFocus:!1}),M=(0,f.useCallback)(()=>{var e;n&&y({prompt:(null!=(e=n.content)?e:[]).filter(e=>"text"===e.type).map(e=>e.text).join(""),attachments:n.attachments||[],files:n.files_v2||[]})},[n,y]),E=(0,f.useCallback)(()=>{u.current&&(u.current.abort(),u.current=null),c.current&&(clearTimeout(c.current),c.current=null)},[]),N=(0,f.useCallback)(()=>{let e=v(t),a=e.filter(e=>e.uuid!==(null==n?void 0:n.uuid)&&e.uuid!==l.current);a.length!==e.length&&p(t,a)},[t,v,null==n?void 0:n.uuid,p]),R=(0,f.useCallback)((e,t)=>{N(),M();let n=e||"Message failed. Please try again.";h(n,{error:new ee.LG(n,t||"completion_error",500,{}),errorContext:{tags:{source:"pending_message_recovery"}}})},[N,M,h]),I=(0,f.useCallback)(()=>{if(!(null==_?void 0:_.uuid)||!t||!n)return;k(!0),u.current=new AbortController;let e=0,a=async()=>{var n,i,s;if(e>=10||(null==(n=u.current)?void 0:n.signal.aborted))return void k(!1);e++;try{let e=await fetch("/api/organizations/".concat(_.uuid,"/chat_conversations/").concat(t,"/completion_status?poll=true"),{method:"GET",credentials:"include",signal:null==(i=u.current)?void 0:i.signal});if(!e.ok)return void k(!1);let n=await e.json();n.is_pending?(null==(s=u.current)?void 0:s.signal.aborted)||(c.current=setTimeout(()=>void a(),2e3)):(S(!1),k(!1),N(),n.is_error&&R(n.error_detail,n.error_code),await (0,r.C4)(x,_.uuid,t))}catch(e){k(!1)}};a()},[null==_?void 0:_.uuid,t,n,x,R,N]);return(0,f.useEffect)(()=>{if(!i&&!s.current&&n&&a&&void 0!==j){if(s.current=!0,j.is_error)R(j.error_detail,j.error_code);else if(j.is_pending){S(!0);let e=(0,Q.b)();l.current=e;let a={uuid:e,sender:"assistant",content:[{type:"text",text:""}],created_at:new Date().toISOString(),updated_at:new Date().toISOString(),parent_message_uuid:n.uuid,attachments:[],files:[],files_v2:[],sync_sources:[],index:1,metadata:{is_resume_completion_placeholder_message:!0}};g(t,[n,a]),I()}}},[i,n,a,j,R,g,t,I]),(0,f.useEffect)(()=>()=>{E()},[E]),{hasPendingUserMessage:b,isCompletionStatusLoading:!!n&&w&&!C,stopPendingRecovery:()=>k(!1)}}({conversationUuid:c,chatConversationTree:w,pendingUserMessage:ea?void 0:R,isLoading:M});w||M||N||(0,b.notFound)();let e_=(0,f.useMemo)(()=>{var e,t;return null!=(t=null!=(e=null==l?void 0:l.settings)?e:null==w?void 0:w.settings)?t:{}},[null==l?void 0:l.settings,null==w?void 0:w.settings]);return(0,a.jsxs)(h.N,{settings:e_,children:[(0,a.jsx)(Z.v,{isStreaming:el||eg,isTemporary:!!(null==l?void 0:l.is_temporary),chatInputDefaultMessage:p,conversationTitle:l?"".concat(l.name," - Claude"):"Claude",conversationUuid:c,isLoading:M||!w&&E||ep,messageUuids:T,name:null!=(s=null!=(i=null==w?void 0:w.name)?i:null==l?void 0:l.name)?s:"Untitled Chat",onSend:eo,onRetry:ed,projectUuid:I,changeDisplayedConversationPath:ef,editMessage:em,setPersonalizedStyleCallback:W,retryCount:H,onStopSampling:eg?ev:void 0,isReconnected:eu}),(0,U.F)()&&(0,a.jsx)(O,{})]})}var en=n(71302),ea=n(88769);function er(e){let{uuid:t,q:n}=e,{data:u,currentPath:o,isLoading:d}=(0,r.Bq)(t);(0,i.K7)(null!=(c=null==u?void 0:u.name)?c:"");var c,m=o||[];let g=(0,q.Gu)(),{clearAllFeatures:p}=(0,ea.Bk)();return(0,f.useLayoutEffect)(()=>(d||g(t,m),()=>{p()}),[t,m,d,g,p]),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(l.u,{conversationUuid:t,children:(0,a.jsx)(s._,{conversationUuid:t,children:(0,a.jsx)(et,{conversation:u,conversationUuid:t,chatInputDefaultMessage:n})})}),(0,a.jsx)(en.PaymentVerificationModal,{})]})}},71302:(e,t,n)=>{n.r(t),n.d(t,{PaymentVerificationModal:()=>v});var a=n(54568),r=n(74813),i=n(44995),s=n(64328),l=n(35984),u=n(77223),o=n(26819),d=n(3075),c=n(4869),m=n(7620),f=n(59666),g=n(48579),p=n(89060);function v(){let[e,t]=(0,m.useState)(!1),n=(0,r.st)(),{activeOrganization:v}=(0,s.YL)(),{addError:_,addSuccess:h}=(0,l.Y)(),y=(0,i._r)(),x=(0,c.useQueryClient)(),{shouldShowModal:b,dismissReminder:S}=(0,p.F)(),C=(0,g.Si)({onSuccess:async e=>{try{var r,i;let t=await (0,u.nW)(e.entity,y);if(!t)throw Error("Stripe failed to initialize");let s=await t.retrieveSetupIntent(e.clientSecret);if(s.error)throw Error(s.error.message);if((null==(r=s.setupIntent)?void 0:r.status)==="requires_action"){let n=await t.handleNextAction({clientSecret:e.clientSecret});if(n.error)throw Error(n.error.message)}else(null==(i=s.setupIntent)?void 0:i.status)==="succeeded"&&n.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_success_frictionless"});await x.invalidateQueries({queryKey:["check-3ds-required",null==v?void 0:v.uuid]}),n.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_success"}),h((0,a.jsx)(f.A,{defaultMessage:"Payment method verified successfully",id:"vRXoCh/o7W"})),n.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_success"})}catch(e){_(e instanceof Error?"PAYMENT_VERIFICATION_FAILED"===e.message?(0,a.jsx)(f.A,{defaultMessage:"Payment verification failed",id:"9RpX03Q2ky"}):e.message.includes("Failed to redirect to https://hooks.stripe.com")||e.message.includes("3d_secure")||e.message.includes("hooks.stripe.com")?(0,a.jsx)(f.A,{defaultMessage:"Unable to complete payment verification. Check if pop-ups are blocked or try a different browser.",id:"sDFdJ5I8X1"}):e.message:(0,a.jsx)(f.A,{defaultMessage:"Payment verification failed. Please try again.",id:"0kXa3Rf5bZ"}),{error:e,errorContext:{tags:{source:"payment_verification"}}}),n.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_error",error_message:e instanceof Error?e.message:"Unknown error"})}finally{t(!1)}},onError:e=>{t(!1),_((0,a.jsx)(f.A,{defaultMessage:"Failed to start verification process. Please try again.",id:"3dT/r8rV5S"}),{error:e}),n.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_api_error",error_message:e.message})}}),k=()=>{S()};return b?(0,a.jsx)(d.aF,{isOpen:b,onClose:k,modalSize:"md",hasCloseButton:!0,title:(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsx)(o.E,{color:"secondary",size:"lg",children:(0,a.jsx)(f.A,{defaultMessage:"Action Required",id:"jWgFDt2Ifa"})})}),children:(0,a.jsxs)("div",{className:"mt-4",children:[(0,a.jsx)("h2",{className:"text-3xl font-medium text-text-100 mb-3",children:(0,a.jsx)(f.A,{defaultMessage:"Verify your payment method",id:"epYApo9bIj"})}),(0,a.jsx)("p",{className:"text-text-200 mb-6",children:(0,a.jsx)(f.A,{defaultMessage:"To comply with European security regulations, we need to verify your payment method using a quick one-time security process. This ensures your subscription remains active and secure.",id:"K0hDpiUx0B"})}),(0,a.jsxs)("div",{className:"flex flex-col gap-2 mt-6",children:[(0,a.jsx)(d.yl,{onClick:()=>{t(!0),n.track({event_key:"payment_modal_open",organization_id:null==v?void 0:v.uuid,action:"verify_3ds_start"});let e=window.location.href;C.mutate({return_url:e})},loading:e,className:"w-full",children:(0,a.jsx)(f.A,{defaultMessage:"Verify now",id:"t28SE7zKVA"})}),(0,a.jsx)(d.yl,{variant:"secondary",onClick:k,className:"w-full",children:(0,a.jsx)(f.A,{defaultMessage:"Remind me later",id:"c4hRLOnYpQ"})})]})]})}):null}},89060:(e,t,n)=>{n.d(t,{F:()=>o});var a=n(74813),r=n(64328),i=n(68067),s=n(7620),l=n(48579);let u="payment-verification-reminder-dismissed";function o(){let{activeOrganization:e}=(0,r.YL)(),t=(0,a.st)(),[n,o]=(0,s.useState)(!1),d=(0,i.fS)("show_3ds_modal"),{data:c}=(0,l.PI)(d);return(0,s.useEffect)(()=>{var n;let a=localStorage.getItem(u);if(a){let e=new Date(a).getTime();if(new Date().getTime()-e<864e5)return void o(!1)}let r=d&&null!=(n=null==c?void 0:c.requires_3ds_verification)&&n;o(r),r&&t.track({event_key:"payment_modal_open",organization_id:null==e?void 0:e.uuid,modal_type:"3ds_verification_required"})},[d,c,t,e]),{shouldShowModal:n,dismissReminder:(0,s.useCallback)(()=>{let n=new Date().toISOString();localStorage.setItem(u,n),o(!1),t.track({event_key:"payment_modal_open",organization_id:null==e?void 0:e.uuid,action:"3ds_verification_dismissed",dismissed_at:n})},[t,e])}}}}]);